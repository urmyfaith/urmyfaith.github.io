<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta http-equiv="content-type" content="text/html;charset=UTF-8">
   <style type="text/css">
   /*CSS stylesheet is based on killwing's flavored markdown style:https://gist.github.com/2937864*/body{    margin: 0 auto;    font: 13px/1.231 Helvetica, Arial, sans-serif;    color: #444444;    line-height: 1;    max-width: 960px;    padding: 5px;}h1, h2, h3, h4 {    color: #111111;    font-weight: 400;}h1, h2, h3, h4, h5, p {    margin-bottom: 16px;    padding: 0;}h1 {    font-size: 28px;}h2 {    font-size: 22px;    margin: 20px 0 6px;}h3 {    font-size: 21px;}h4 {    font-size: 18px;}h5 {    font-size: 16px;}a {    color: #0099ff;    margin: 0;    padding: 0;    vertical-align: baseline;}a:link,a:visited{ text-decoration:none;}a:hover{ text-decoration:underline;}ul, ol {    padding: 0;    margin: 0;}li {    line-height: 24px;    margin-left: 44px;}li ul, li ul {    margin-left: 24px;}ul, ol {    font-size: 14px;    line-height: 20px;    max-width: 540px;}p {    font-size: 14px;    line-height: 20px;    max-width: 540px;    margin-top: 3px;}pre {    padding: 0px 4px;    max-width: 800px;    white-space: pre-wrap;    font-family: Consolas, Monaco, Andale Mono, monospace;    line-height: 1.5;    font-size: 13px;    border: 1px solid #ddd;    background-color: #f7f7f7;    border-radius: 3px;}code {    font-family: Consolas, Monaco, Andale Mono, monospace;    line-height: 1.5;    font-size: 13px;    border: 1px solid #ddd;    background-color: #f7f7f7;    border-radius: 3px;}pre code {    border: 0px;}aside {    display: block;    float: right;    width: 390px;}blockquote {    border-left:.5em solid #40AA53;    padding: 0 2em;    margin-left:0;    max-width: 476px;}blockquote  cite {    font-size:14px;    line-height:20px;    color:#bfbfbf;}blockquote cite:before {    content: '\2014 \00A0';}blockquote p {      color: #666;    max-width: 460px;}hr {    height: 1px;    border: none;    border-top: 1px dashed #0066CC}button,input,select,textarea {  font-size: 100%;  margin: 0;  vertical-align: baseline;  *vertical-align: middle;}button, input {  line-height: normal;  *overflow: visible;}button::-moz-focus-inner, input::-moz-focus-inner {  border: 0;  padding: 0;}button,input[type="button"],input[type="reset"],input[type="submit"] {  cursor: pointer;  -webkit-appearance: button;}input[type=checkbox], input[type=radio] {  cursor: pointer;}/* override default chrome & firefox settings */input:not([type="image"]), textarea {  -webkit-box-sizing: content-box;  -moz-box-sizing: content-box;  box-sizing: content-box;}input[type="search"] {  -webkit-appearance: textfield;  -webkit-box-sizing: content-box;  -moz-box-sizing: content-box;  box-sizing: content-box;}input[type="search"]::-webkit-search-decoration {  -webkit-appearance: none;}label,input,select,textarea {  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;  font-size: 13px;  font-weight: normal;  line-height: normal;  margin-bottom: 18px;}input[type=checkbox], input[type=radio] {  cursor: pointer;  margin-bottom: 0;}input[type=text],input[type=password],textarea,select {  display: inline-block;  width: 210px;  padding: 4px;  font-size: 13px;  font-weight: normal;  line-height: 18px;  height: 18px;  color: #808080;  border: 1px solid #ccc;  -webkit-border-radius: 3px;  -moz-border-radius: 3px;  border-radius: 3px;}select, input[type=file] {  height: 27px;  line-height: 27px;}textarea {  height: auto;}/* grey out placeholders */:-moz-placeholder {  color: #bfbfbf;}::-webkit-input-placeholder {  color: #bfbfbf;}input[type=text],input[type=password],select,textarea {  -webkit-transition: border linear 0.2s, box-shadow linear 0.2s;  -moz-transition: border linear 0.2s, box-shadow linear 0.2s;  transition: border linear 0.2s, box-shadow linear 0.2s;  -webkit-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);  -moz-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);}input[type=text]:focus, input[type=password]:focus, textarea:focus {  outline: none;  border-color: rgba(82, 168, 236, 0.8);  -webkit-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);  -moz-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);}/* buttons */button {  display: inline-block;  padding: 4px 14px;  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;  font-size: 13px;  line-height: 18px;  -webkit-border-radius: 4px;  -moz-border-radius: 4px;  border-radius: 4px;  -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);  -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);  background-color: #0064cd;  background-repeat: repeat-x;  background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));  background-image: -moz-linear-gradient(top, #049cdb, #0064cd);  background-image: -ms-linear-gradient(top, #049cdb, #0064cd);  background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));  background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);  background-image: -o-linear-gradient(top, #049cdb, #0064cd);  background-image: linear-gradient(top, #049cdb, #0064cd);  color: #fff;  text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);  border: 1px solid #004b9a;  border-bottom-color: #003f81;  -webkit-transition: 0.1s linear all;  -moz-transition: 0.1s linear all;  transition: 0.1s linear all;  border-color: #0064cd #0064cd #003f81;  border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);}button:hover {  color: #fff;  background-position: 0 -15px;  text-decoration: none;}button:active {  -webkit-box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);  -moz-box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);  box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);}button::-moz-focus-inner {  padding: 0;  border: 0;}/* table  */table {    border-spacing: 0;    border: 1px solid #ccc;}td, th{    border: 1px solid #ccc;    padding: 5px;}/* code syntax highlight.Documentation: http://www.mdcharm.com/documentation/code_syntax_highlighting.html#custom_your_own */pre .literal,pre .comment,pre .template_comment,pre .diff .header,pre .javadoc {    color: #008000;}pre .keyword,pre .css .rule .keyword,pre .winutils,pre .javascript .title,pre .nginx .title,pre .subst,pre .request,pre .status {    color: #0000FF;    font-weight: bold}pre .number,pre .hexcolor,pre .python .decorator,pre .ruby .constant {    color: #0000FF;}pre .string,pre .tag .value,pre .phpdoc,pre .tex .formula {    color: #D14}pre .title,pre .id {    color: #900;    font-weight: bold}pre .javascript .title,pre .lisp .title,pre .clojure .title,pre .subst {    font-weight: normal}pre .class .title,pre .haskell .type,pre .vhdl .literal,pre .tex .command {    color: #458;    font-weight: bold}pre .tag,pre .tag .title,pre .rules .property,pre .django .tag .keyword {    color: #000080;    font-weight: normal}pre .attribute,pre .variable,pre .lisp .body {    color: #008080}pre .regexp {    color: #009926}pre .class {    color: #458;    font-weight: bold}pre .symbol,pre .ruby .symbol .string,pre .lisp .keyword,pre .tex .special,pre .prompt {    color: #990073}pre .built_in,pre .lisp .title,pre .clojure .built_in {    color: #0086b3}pre .preprocessor,pre .pi,pre .doctype,pre .shebang,pre .cdata {    color: #999;    font-weight: bold}pre .deletion {    background: #fdd}pre .addition {    background: #dfd}pre .diff .change {    background: #0086b3}pre .chunk {    color: #aaa}pre .markdown .header {    color: #800;    font-weight: bold;}pre .markdown .blockquote {    color: #888;}pre .markdown .link_label {    color: #88F;}pre .markdown .strong {    font-weight: bold;}pre .markdown .emphasis {    font-style: italic;}
   </style>
   
   
</head>
<body>
    <h1>实现微信公众号/订阅号的一些功能</h1>

<hr>

<h3>需要实现的功能有哪些?</h3>

<pre><code>最近学着开了一个订阅号,本来就是用来发一些文章,记录一些读书笔记的,后来,又不满足于这些,于是接着微信的开放借口,尝试着写出一些功能.

最初是想学着自动回复,然后发现,自动回复里面的内容太多了,如果真的实现起来,像小黄鸡?像微软小兵一样的智能机器人,如果真的实现起来,就只有去抓去别人的结果了.

归纳起来,最初想实现的是:
</code></pre>

<ul>
<li><p>接口的认证</p></li>
<li><p>自动回复消息</p></li>
</ul>

<hr>

<h3>实现目标的过程</h3>

<pre><code>一开始看别人的代码,拷贝过来,然后发现,有点难度.所以就去学习了一下webpy.
</code></pre>

<h5>0.开发环境</h5>

<ul>
<li>代码运行在SAE上</li>
<li>代码使用SVN管理,在本地编写.</li>
<li>使用SAE的&quot;日志中心&quot;&gt;&quot;http&quot;&gt;&quot;request&quot;和&quot;日志中心&quot;&gt;&quot;http&quot;&gt;&quot;debug&quot;来进行调试</li>
</ul>

<h5>1.学习weby</h5>

<pre><code class="c">+---basic application
|   +---helloword
|   |       <span class="number">01</span>helloworld.py
|   |       <span class="number">01</span>helloworld.pyc
|   |       
|   +---notfound
|   |   |   notfound.py
|   |   |   notfound.pyc
|   |   |   notfound02.py
|   |   |   notfound02.pyc
|   |   |   
|   |   \---templates
|   |           notfound.html
|   |           
|   \---xmlfile
|       |   xmlfile.py
|       |   xmlfile.pyc
|       |   xmlfiles.png
|       |   
|       \---templates
|               response.xml
|               
+---db
|   |   dbV000_select.py
|   |   dbV000_select.pyc
|   |   dbV001_add.py
|   |   dbV001_add.pyc
|   |   todo.sql
|   |   连接问题.txt
|   |   
|   \---templates
|           index - 副本.html
|           index.html
|           
+---form
|   |   formV000.py
|   |   formV000.pyc
|   |   formV001.py
|   |   formV001.pyc
|   |   formV002.png
|   |   formV002.py
|   |   formV002.pyc
|   |   formV003.png
|   |   formV003.py
|   |   formV003.pyc
|   |   formV004.py
|   |   formV004.pyc
|   |   
|   \---templates
|           formtest.html
|           
+---Templetor
|   |   01templetor.py
|   |   01templetor.pyc
|   |   02templetor-template-as-string.py
|   |   03templetor-newline.py
|   |   03templetor-newline.pyc
|   |   04templetor-escaping .py
|   |   04templetor-escaping .pyc
|   |   05templetor-control-structures.py
|   |   05templetor-control-structures.pyc
|   |   
|   \---templates
|           controlStructures.html
|           escaping.html
|           index.html
|           newline.html
|           
+---urls
|   |   codeV000.py
|   |   codeV001.py
|   |   codeV001.pyc
|   |   codeV002.py
|   |   codeV002.pyc
|   |   
|   \---templates
|           index.html
|           
\---wiki
    |   model.py
    |   model.pyc
    |   schema.sql
    |   wiki.py
    |   wiki.pyc
    |   
    \---templates
            base.html
            edit.html
            index.html
            new.html
            view.html
</code></pre>

<p>学习webpy就照着官网,学习了:</p>

<ul>
<li><p>入门教程:  <a href="http://webpy.org/docs/0.3/tutorial.zh-cn">http://webpy.org/docs/0.3/tutorial.zh-cn</a></p></li>
<li><p>cookbook: <a href="http://webpy.org/cookbook/index.zh-cn">http://webpy.org/cookbook/index.zh-cn</a></p></li>
<li><ul>
<li> helloworld</li>
</ul></li>
<li><ul>
<li> urls</li>
</ul></li>
<li><ul>
<li> db</li>
</ul></li>
<li><ul>
<li> wiki</li>
</ul></li>
<li><ul>
<li> Templetor</li>
</ul></li>
</ul>

<p>在学习了这些基础的知识之后,实现我们的目标:</p>

<ul>
<li>认证</li>
<li>回复固定值</li>
</ul>

<p>就相对容易了很多.</p>

<hr>

<h5>2.拷贝代码,修改代码.</h5>

<p>实现认证的代码只需要三个主语的文件:</p>

<ul>
<li>index.wsgi</li>
<li>weixinInterface.py</li>
<li>config.yaml</li>
</ul>

<p>第一个文件用来处理URL:/weixin 路径用第二个文件weixinInterface类来实现</p>

<p>第三个文件是一些SAE上的配置文件.</p>

<h5>3.遇到问题的解决</h5>

<p>遇到的问题有:</p>

<ol>
<li>认证通过后,回复消息,无应答,却不知道怎么调试.</li>
<li>知道怎么调试之后,遇到的各种问题:405,500</li>
<li>代码对齐的问题</li>
<li>为导入库的问题</li>
<li>获取值属性错误</li>
<li>字符编码问题ascii和utf-8编码的问题</li>
<li>结果为空的问题</li>
<li>变量没有定于的问题</li>
<li>无效的表达式,也就是代码一些括号匹配的问题
10.某些属性的大小写问题</li>
<li>如果使用SAE上的数据库的select,insert,delete等,关键是如何查询和删除.</li>
</ol>

<p><strong>问题1:</strong>
调试后来在SAE的帮助文档里找到了:</p>

<p><a href="http://sae.sina.com.cn/doc/python/runtime.html#id4">http://sae.sina.com.cn/doc/python/runtime.html#id4</a></p>

<p>日志系统的使用.</p>

<pre><code class="c"><span class="number">101.226</span><span class="number">.62</span><span class="number">.85</span> [<span class="number">20</span>/Jul/<span class="number">2014</span>:<span class="number">18</span>:<span class="number">10</span>:<span class="number">43</span> +<span class="number">0800</span>] /weixin?signature=b165650640ad0ddf52d84fe6d1a9eec69935f8f4&amp;timestamp=<span class="number">1405851012</span>&amp;nonce=<span class="number">734319259</span> <span class="number">200</span> <span class="number">0.152</span> <span class="number">0.152</span> <span class="number">458</span> 
urmyfaith.sinaapp.com POST HTTP/<span class="number">1.0</span> <span class="string">"-"</span> <span class="string">"Mozilla/4.0"</span> yq34
</code></pre>

<p>从日志系统里可以找到HTTP响应码,200,404,405,500
200 正常
404 页面问找到
405 请求方法错误(后来确定是因为POST方法的缩进导致)
500 内部错误(需要到debug里定位错误)</p>

<p>从&quot;日志中心&quot;&gt;&quot;http&quot;&gt;&quot;debug&quot;里可以定位各种错误,很方便修改.</p>

<p><strong>问题2,3</strong></p>

<p>都是因为POST方法缩进错误导致.(缩进错误是因为editplus和python IDLE的缩进不一致导致)</p>

<p><strong>问题4</strong></p>

<p>由于没有导入相应库导致,从debug里可以查看到.</p>

<p><strong>问题5,7,8</strong></p>

<p>某些值的获取错误,从debug里定位,要么是因为结果为空,大小写不对应(sql数据库里的table里的字段名大小写不一致导致.)</p>

<p><strong>问题6</strong></p>

<p>ascii和utf-8的问题也是由于各个系统的编码不一致导致,mysql里的默认为utf-8,然后python读出来ascii编码,需要进行encode,或者是在字符串前加u,例如:u&quot;中国&quot;.</p>

<p><strong>问题11</strong></p>

<p>sae上数据库的读写时遇到两个问题:</p>

<ol>
<li>删除数据的条件</li>
<li>选择数据的条件</li>
</ol>

<p>删除数据的时候,</p>

<pre><code class="python">            where_dict={<span class="string">'id'</span>:currID,}
            db.delete(<span class="string">'article'</span>,where=web.db.sqlwhere(where_dict))
</code></pre>

<p>选择数据查询的时候,</p>

<pre><code class="python">   myvar=dict(dateInWhere=dateNow)
   currLines = db.select(<span class="string">'birthday'</span>,myvar,where=<span class="string">"date &gt;         
   $dateInWhere"</span>,limit=<span class="number">1</span>,order=<span class="string">"date ASC"</span>)
</code></pre>

<p>特别是后面的,myvar的使用,和<strong>myvar的位置</strong>,以及date的数据库字段的设计的问题,究竟是TEXT,DATE类型的问题,还有选择逻辑的考虑(order by asc),还有冒号里面,究竟用不用$等问题,都需要去尝试才知道怎么做.</p>

<p>解决这些问题的时候,参考</p>

<p><a href="http://webpy.org/cookbook/index.zh-cn">http://webpy.org/cookbook/index.zh-cn</a></p>

<p>里的[Database 数据库]部分,很有大的帮助.</p>

<p>其次,去百度一下debug的错误,差不多都可以找到答案.(谷歌的原因,唉...)</p>

<h3>目标实现后的小结</h3>

<p>确实很花时间,需要去学习webpy,熟悉微信API里的接口文档,SAE的调试,SAE数据库的操作,数据库字段的设计,原始数据的生成,数据怎么获得,格式的转换等等.</p>

<p>后续有时间再实现一些小功能吧.</p>

<p>现在实现的功能有:</p>

<pre><code class="python">                      <span class="string">"00"</span>:反馈,
                      "12":分享文章,
                      "14":笑话(待完成,原始资料木有),
                      <span class="string">"25"</span>:发表情卖萌,
                      <span class="number">"3</span><span class="number">6</span>":格言(待完成,原始资料木有),
                      "47":猜你在做什么,
                      "0110<span class="number">9</span>07<span class="string">":班级生日总表,
                      "birthday":随机挑选一个生日,
                      "bd":最近要过生日的人,
</code></pre>

</body>
</html>